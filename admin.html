<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel | PrasaTek</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script>
/* ðŸš¨ HARD BLOCK BEFORE PAGE LOAD */
if(sessionStorage.getItem("adminLogged")!=="true"){
  location.replace("adminlog.html");
}
</script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins}
body{background:#f4f6f8}
header{
  background:#0a3d62;color:#fff;
  padding:15px 8%;
  display:flex;justify-content:space-between
}
section{padding:30px 8%}
h2{color:#0a3d62;margin-bottom:10px}
input,textarea{
  width:100%;padding:10px;margin:6px 0;
  border-radius:8px;border:1px solid #ccc
}
button{
  padding:6px 14px;border:none;border-radius:20px;
  background:#25D366;color:#fff;cursor:pointer;margin:4px
}
.danger{background:#e74c3c}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:15px}
.card{
  background:#fff;padding:18px;border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.1)
}
.scroll{max-height:300px;overflow:auto}

/* POPUP */
#popup{
  position:fixed;bottom:20px;right:20px;
  background:#333;color:#fff;
  padding:14px 22px;border-radius:12px;
  display:none
}
</style>
</head>

<body>

<header>
  <strong>PrasaTek Admin</strong>
  <button onclick="logout()">Logout</button>
</header>

<section>
<h2>Contact Settings</h2>
<input id="phone" placeholder="Phone">
<input id="email" placeholder="Email">
<input id="address" placeholder="Address">
<button onclick="saveSettings()">Update</button>
</section>

<section>
<h2>Services</h2>
<input id="srvName" placeholder="Service name">
<textarea id="srvDesc" placeholder="Description"></textarea>
<button onclick="addService()">Add</button>
<div id="services" class="grid"></div>
</section>

<section>
<h2>Products</h2>
<input id="prdName" placeholder="Product name">
<textarea id="prdDesc" placeholder="Description"></textarea>
<button onclick="addProduct()">Add</button>
<div id="products" class="grid"></div>
</section>

<section>
<h2>Pending Reviews</h2>
<div id="pending" class="grid scroll"></div>
</section>

<section>
<h2>Approved Reviews</h2>
<div id="approved" class="grid scroll"></div>
</section>

<div id="popup"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore, collection, getDocs, addDoc,
  deleteDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig={
  apiKey:"AIzaSyDijkYp6_KD3B3UXfNs59LgTUeaKOFDZ7s",
  authDomain:"prasatek-8a823.firebaseapp.com",
  projectId:"prasatek-8a823"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

/* DOUBLE AUTH CHECK */
onAuthStateChanged(auth,user=>{
  if(!user){
    sessionStorage.clear();
    location.replace("adminlog.html");
  }
});

/* POPUP */
const pop=document.getElementById("popup");
const popup=msg=>{
  pop.innerText=msg;
  pop.style.display="block";
  setTimeout(()=>pop.style.display="none",2500);
};

/* LOGOUT */
window.logout=()=>{
  signOut(auth);
  sessionStorage.clear();
  location.replace("adminlog.html");
};

/* SETTINGS */
async function loadSettings(){
  const s=await getDocs(collection(db,"settings"));
  s.forEach(d=>{
    phone.value=d.data().phone||"";
    email.value=d.data().email||"";
    address.value=d.data().address||"";
  });
}
window.saveSettings=async()=>{
  await addDoc(collection(db,"settings"),{
    phone:phone.value,email:email.value,address:address.value
  });
  popup("Updated");
};

/* SERVICES */
async function loadServices(){
  services.innerHTML="";
  const s=await getDocs(collection(db,"services"));
  s.forEach(d=>{
    services.innerHTML+=`
    <div class="card">
      <b>${d.data().name}</b>
      <p>${d.data().desc}</p>
      <button onclick="edit('services','${d.id}','${d.data().name}','${d.data().desc}')">Edit</button>
      <button class="danger" onclick="del('services','${d.id}')">Delete</button>
    </div>`;
  });
}
window.addService=async()=>{
  await addDoc(collection(db,"services"),{
    name:srvName.value,desc:srvDesc.value
  });
  srvName.value=srvDesc.value="";
  loadServices(); popup("Service added");
};

/* PRODUCTS */
async function loadProducts(){
  products.innerHTML="";
  const s=await getDocs(collection(db,"products"));
  s.forEach(d=>{
    products.innerHTML+=`
    <div class="card">
      <b>${d.data().name}</b>
      <p>${d.data().desc}</p>
      <button onclick="edit('products','${d.id}','${d.data().name}','${d.data().desc}')">Edit</button>
      <button class="danger" onclick="del('products','${d.id}')">Delete</button>
    </div>`;
  });
}
window.addProduct=async()=>{
  await addDoc(collection(db,"products"),{
    name:prdName.value,desc:prdDesc.value
  });
  prdName.value=prdDesc.value="";
  loadProducts(); popup("Product added");
};

/* REVIEWS */
async function loadReviews(){
  pending.innerHTML=""; approved.innerHTML="";
  const s=await getDocs(collection(db,"reviews"));
  s.forEach(d=>{
    const r=d.data();
    const box=`
    <div class="card">
      <b>${r.name}</b> (${r.email})
      <p>${r.message}</p>
      ${r.approved
      ?`<button class="danger" onclick="del('reviews','${d.id}')">Delete</button>`
      :`<button onclick="approve('${d.id}')">Approve</button>
        <button class="danger" onclick="del('reviews','${d.id}')">Reject</button>`}
    </div>`;
    r.approved?approved.innerHTML+=box:pending.innerHTML+=box;
  });
}
window.approve=async(id)=>{
  await updateDoc(doc(db,"reviews",id),{approved:true});
  popup("Approved"); loadReviews();
};

/* EDIT */
window.edit=async(col,id,n,d)=>{
  const name=prompt("Edit name",n);
  const desc=prompt("Edit description",d);
  if(!name||!desc) return;
  await updateDoc(doc(db,col,id),{name,desc});
  popup("Updated");
  loadServices(); loadProducts();
};

/* DELETE */
window.del=async(col,id)=>{
  await deleteDoc(doc(db,col,id));
  popup("Deleted");
  loadServices(); loadProducts(); loadReviews();
};

/* INIT */
loadSettings(); loadServices(); loadProducts(); loadReviews();
</script>

</body>
</html>
